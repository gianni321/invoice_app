# Development Dockerfile with hot reloading
FROM node:20-alpine AS development

# Install development tools
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    bash \
    curl

# Create app user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S appuser -u 1001

WORKDIR /app

# Copy package files
COPY backend/package*.json ./backend/
COPY frontend/package*.json ./frontend/

# Install dependencies
RUN cd backend && npm install
RUN cd frontend && npm install

# Copy source code
COPY --chown=appuser:nodejs backend/ ./backend/
COPY --chown=appuser:nodejs frontend/ ./frontend/

# Build frontend for development
RUN cd frontend && npm run build

# Create necessary directories
RUN mkdir -p backend/logs backend/uploads && \
    chown -R appuser:nodejs /app

# Switch to non-root user
USER appuser

# Expose ports
EXPOSE 3001 9229

# Development command with hot reloading
CMD ["npm", "run", "dev", "--prefix", "backend"]